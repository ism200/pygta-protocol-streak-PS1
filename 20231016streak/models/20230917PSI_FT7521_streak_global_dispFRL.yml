default_megacomplex: decay
dataset_groups:
  streak:
    residual_function: non_negative_least_squares
    link_clp: True
  default:
    residual_function: variable_projection
    link_clp: True

dataset:
  FT7521FRLtr1:
    group: streak
    megacomplex: [FT7521complexFRL,freeChla,freeChlf]
    megacomplex_scale: [FT7521scalem.1,FT7521scalem.FRLtr1a,FT7521scalem.FRLtr1f]
    initial_concentration: FT7521inputFRL
    irf: FT7521irfFRLtr1
    scale: FT7521scale.FRLtr1
  FT7521FRLtr2:
    group: streak
    megacomplex: [FT7521complexFRL,freeChla,freeChlf]
    megacomplex_scale: [FT7521scalem.1,FT7521scalem.FRLtr2a,FT7521scalem.FRLtr2f]
    initial_concentration: FT7521inputFRL
    irf: FT7521irfFRLtr2
    scale: FT7521scale.FRLtr2
  FT7521FRLtr4:
    group: streak
    megacomplex: [FT7521complexFRL,freeChla,freeChlf]
    megacomplex_scale: [FT7521scalem.1,FT7521scalem.FRLtr4a,FT7521scalem.FRLtr4f]
    initial_concentration: FT7521inputFRL
    irf: FT7521irfFRLtr4
    scale: FT7521scale.FRLtr4
  freeChlaSAS:
    group: streak
    megacomplex:
    - smc12
    scale: scale.freeChlaSAS

megacomplex:
  FT7521complexFRL:
    k_matrix: [FT7521FRL]
  freeChla:
    k_matrix: [FT7521kmChla]
  freeChlf:
    k_matrix: [FT7521kmChlf]
  # FT7521complexWL:
  #   k_matrix: [FT7521WL]
  smc12:
    dimension: time
    target: freeChla
    type: clp-guide

# note that earlier definition will override later definition
# xrates correction for different numbers of Bulk Chl a pigments in WL vs FRL (78 vs 70)
k_matrix:
  FT7521FRL:
    matrix:
      (r2, r1): rates.k21
      (r3, r2): rates.k32
      (r4, r3): rates.k43
      (r4, r4): rates.k44
  # FT7521WL:
  #   matrix:
  #     (br2, br1): brates.k21
  #     (br3, br2): brates.k32
  #     (br3, br3): brates.k33
  FT7521kmChla:
    matrix:
      (freeChla, freeChla): FT7521rates.kF
      # (br4, br4): brates.k44
  FT7521kmChlf:
    matrix:
      (freeChlf, freeChlf): FT7521rates.kFf
#

initial_concentration:
  FT7521inputFRL:
    compartments: [r1,r2,r3,r4,freeChla,freeChlf]
    parameters: [input.1, input.0, input.0, input.0, input.1,  input.1]
    exclude_from_normalize: [freeChla,freeChlf]
  # FT7521inputWL:
  #   compartments: [br1,br2,br3,freeChla]
  #   parameters: [input.1, input.0, input.0, input.1]
  #   exclude_from_normalize: [freeChla,br4]

clp_penalties:
  # - type: equal_area
  #   source: r1
  #   source_intervals: [[0, 1000]]
  #   target: br1
  #   target_intervals: [[0, 1000]]
  #   parameter: area.1
  #   weight: 0.62e-2
  - type: equal_area
    source: r1
    source_intervals: [[0, 1000]]
    target: freeChlf
    target_intervals: [[0, 1000]]
    parameter: area.Bulk
    weight: 0.62e-2
  - type: equal_area
    source: freeChla
    source_intervals: [[0, 1000]]
    target: freeChlf
    target_intervals: [[0, 1000]]
    parameter: area.1
    weight: 0.62e-2
#   - type: equal_area
#     source: sRed1
#     source_intervals: [[0, 1000]]
#     target: FT7521Red2
#     target_intervals: [[0, 1000]]
#     parameter: area.1
#     weight: 0.62
#   - type: equal_area
#     source: sRed1
#     source_intervals: [[0, 1000]]
#     target: FT7521WLRC
#     target_intervals: [[0, 1000]]
#     parameter: area.1
#     weight: 0.62
#   - type: equal_area
#     source: sRed1
#     source_intervals: [[0, 1000]]
#     target: FT7521FRLRC
#     target_intervals: [[0, 1000]]
#     parameter: area.1
#     weight: 0.62
#   - type: equal_area
#     source: sRed1
#     source_intervals: [[0, 1000]]
#     target: FT7521Chlf1
#     target_intervals: [[0, 1000]]
#     parameter: area.1
#     weight: 0.62
#   - type: equal_area
#     source: sRed1
#     source_intervals: [[0, 1000]]
#     target: FT7521Chlf2
#     target_intervals: [[0, 1000]]
#     parameter: area.1
#     weight: 0.62
    #

# clp_relations:
#   - source: freeChla
#     target: br4
#     parameter: rel.r1
#     interval: [[0, 1000]]

clp_constraints:
  - type: zero
    target: freeChlf
    interval:
      - [100, 700]
      #

# it is implicitly normalized, i.e. divided by sum of irfscale parameters
irf:
  FT7521irfFRLtr1:
    type: spectral-multi-gaussian
    center: [FT7521irfFRLtr1.center]
    width: [FT7521irfFRLtr1.width1,FT7521irfFRLtr1.width2]
    scale: [FT7521irfFRLtr1.scale1,FT7521irfFRLtr1.scale2]
    backsweep: True
    backsweep_period: irf.common_backsweep
    dispersion_center: irf.dispcenter
    center_dispersion_coefficients: [irf.disp3,irf.disp4]
  FT7521irfFRLtr2:
    type: spectral-multi-gaussian
    center: [FT7521irfFRLtr2.center]
    width: [FT7521irfFRLtr2.width1,FT7521irfFRLtr2.width2]
    scale: [FT7521irfFRLtr2.scale1,FT7521irfFRLtr2.scale2]
    backsweep: True
    backsweep_period: irf.common_backsweep
    dispersion_center: irf.dispcenter
    center_dispersion_coefficients: [irf.disp3,irf.disp4]
  FT7521irfFRLtr4:
    type: spectral-multi-gaussian
    center: [FT7521irfFRLtr4.center]
    width: [FT7521irfFRLtr4.width1,FT7521irfFRLtr4.width2]
    scale: [FT7521irfFRLtr4.scale1,FT7521irfFRLtr4.scale2]
    backsweep: True
    backsweep_period: irf.common_backsweep
    dispersion_center: irf.dispcenter
    center_dispersion_coefficients: [irf.disp3,irf.disp4]

weights:
  - datasets: [freeChlaSAS]
    global_interval: [100, 1000]
    value: 0.3